<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ§åˆ¶ç”»çº¿å·¥å…·</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!-- jQuery EasyUI -->
    <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/icon.css">
    <script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .upload-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        .upload-area {
            flex: 1;
            min-width: 300px;
            max-width: 500px;
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 2px dashed #d1d9e6;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #3498db;
            background-color: #f0f7ff;
        }
        
        .upload-area h3 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area h3 i {
            font-size: 24px;
        }
        
        .upload-box {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
            margin-bottom: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-box:hover {
            border-color: #3498db;
            background-color: #f8fafc;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #95a5a6;
            margin-bottom: 15px;
        }
        
        .upload-box p {
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .canvas-section {
            margin-top: 20px;
            text-align: center;
        }
        
        .canvas-container {
            display: inline-block;
            margin: 20px auto;
            position: relative;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            color: #555;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .control-panel {
            background-color: #f1f8ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #d1e3ff;
        }
        
        .video-preview {
            margin-top: 30px;
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
            display: none;
        }
        
        .video-preview h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        #resultDrawLine4Video {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .t2i-fill-mask-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        
        .btn-warning:hover {
            background-color: #d35400;
        }
        
        .status-bar {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #555;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .upload-section {
                flex-direction: column;
            }
            
            .upload-area {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è§†é¢‘æ§åˆ¶ç”»çº¿å·¥å…·</h1>
            <p>åœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶çŸ©å½¢å¹¶å½•åˆ¶è¿åŠ¨è½¨è¿¹ï¼Œç”ŸæˆåŠ¨æ€è§†é¢‘</p>
            <input type="file" id="bgImageInput" accept="image/*" style="display: none;">
            <input type="file" id="editImageInput" accept="image/*" style="display: none;">
        </div>
        
        <div class="main-content">
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <div class="upload-area">
                    <h3><i>ğŸ“·</i> A - CanvasèƒŒæ™¯å›¾ç‰‡</h3>
                    <p>ä¸Šä¼ ä½œä¸ºCanvasèƒŒæ™¯çš„å›¾ç‰‡ï¼Œç”¨äºåœ¨å…¶ä¸Šç»˜åˆ¶çŸ©å½¢å’Œè½¨è¿¹</p>
                    <div class="upload-box" id="bgImageUpload">
                        <div class="upload-icon">ğŸ“</div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
                        <p><small>æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 800Ã—600 ä»¥ä¸Š</small></p>
                    </div>
                    <div class="file-info" id="bgImageInfo"></div>
                    <img id="bgImagePreview" class="preview-img" src="" alt="èƒŒæ™¯å›¾ç‰‡é¢„è§ˆ">
                    <button class="btn-primary" id="useBgImageBtn" style="display: none; width: 100%;">ä½¿ç”¨æ­¤å›¾ç‰‡ä½œä¸ºèƒŒæ™¯</button>
                </div>
                
                <div class="upload-area">
                    <h3><i>ğŸ¬</i> B - å¯é€‰ç¼–è¾‘å›¾ç‰‡ (edit_img)</h3>
                    <p>ä¸Šä¼ ä½œä¸ºè§†é¢‘ç”Ÿæˆæ—¶çš„ç¼–è¾‘å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰ï¼Œå°†æ›¿æ¢åŸèƒŒæ™¯</p>
                    <div class="upload-box" id="editImageUpload">
                        <div class="upload-icon">ğŸ“</div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
                        <p><small>å¯é€‰ï¼Œç”¨äºç”Ÿæˆè§†é¢‘æ—¶æ›¿æ¢èƒŒæ™¯</small></p>
                    </div>
                    <div class="file-info" id="editImageInfo"></div>
                    <img id="editImagePreview" class="preview-img" src="" alt="ç¼–è¾‘å›¾ç‰‡é¢„è§ˆ">
                    <div id="editImageStatus" style="margin-top: 10px; font-size: 14px; color: #7f8c8d;"></div>
                </div>
            </div>
            
            <!-- æ§åˆ¶åŒºåŸŸ -->
            <div class="control-panel">
                <h3 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">ç”»å¸ƒæ§åˆ¶</h3>
                
                <div style="text-align: center;">
                    <button class="btn-primary" id="openCanvasBtn">æ‰“å¼€ç”»å¸ƒ</button>
                    <button class="btn-warning" id="clearCanvasBtn" style="display: none;">æ¸…ç©ºç”»å¸ƒ</button>
                </div>
                
                <!-- å·¥å…·æ å®¹å™¨ -->
                <div id="t2video_edit_dl4v_toolbar_pool" style="display:none;text-align: center;line-height:32px;padding:10px 0px; margin-top: 0px;">
                    <div style="width:350px; line-height:32px;display: inline-block;">
                        <div style="width:100px; display: inline-block;">å¯¹è±¡æè¿°ï¼š</div>
                        <div style="width:180px;position: relative;top:0px;display: inline-block;">
                            <input id="t2video_dl4v_replacePrompt" type="text" class="easyui-textbox" data-options="prompt:'ç§»é™¤å¯¹è±¡åç§°ï¼ˆæ•ˆæœæ›´ä½³ï¼‰'">
                        </div>
                    </div>
                    <div style="width:250px; line-height:32px;display: inline-block;">
                        <div style="width:60px; display: inline-block;">æ—¶é•¿ï¼š</div>
                        <div style="width:150px;position: relative;top:10px;display: inline-block;">
                            <input id="t2video_dl4v_duration" class="easyui-slider" style="width:150px;" value="3" data-options="min:1,max:10,step:1,showTip:true">
                        </div>
                    </div>
                    <div style="width:450px; line-height:32px;display: inline-block;">
                        <div style="width:100%; display: inline-block; text-align: center;">
                            <a id="t2video_dl4v_reset" class="easyui-linkbutton" data-options="iconCls:'',disabled:true" href="javascript:void(0)" style="width:80px;">é‡ç½®</a>
                            <a id="t2video_dl4v_set" class="easyui-linkbutton" data-options="iconCls:''" href="javascript:void(0)" style="width:70px;">è½¨è¿¹</a>
                            <a id="t2video_dl4v_ok" class="easyui-linkbutton" data-options="iconCls:''" href="javascript:void(0)" style="width:70px;">ç”Ÿæˆ</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div class="instructions">
                <h3>ä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li><strong>æ­¥éª¤1ï¼š</strong>ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡ï¼ˆAåŒºåŸŸï¼‰å¹¶ç‚¹å‡»"ä½¿ç”¨æ­¤å›¾ç‰‡ä½œä¸ºèƒŒæ™¯"</li>
                    <li><strong>æ­¥éª¤2ï¼š</strong>ç‚¹å‡»"æ‰“å¼€ç”»å¸ƒ"æŒ‰é’®ï¼Œåœ¨å›¾ç‰‡ä¸Šç»˜åˆ¶çŸ©å½¢ï¼ˆç‚¹å‡»å¹¶æ‹–æ‹½ï¼‰</li>
                    <li><strong>æ­¥éª¤3ï¼š</strong>ç‚¹å‡»"è½¨è¿¹"æŒ‰é’®å¼€å§‹å½•åˆ¶ï¼Œç„¶åæ‹–åŠ¨çŸ©å½¢åˆ›å»ºè¿åŠ¨è½¨è¿¹</li>
                    <li><strong>æ­¥éª¤4ï¼š</strong>ç‚¹å‡»"ç”Ÿæˆ"æŒ‰é’®åˆ›å»ºè§†é¢‘ï¼ˆå¯é€‰æ‹©ä¸Šä¼ Bå›¾ç‰‡ç”¨äºè§†é¢‘èƒŒæ™¯æ›¿æ¢ï¼‰</li>
                    <li><strong>æ§åˆ¶æç¤ºï¼š</strong>
                        <ul>
                            <li>æŒ‰ä½Ctrlé”®æˆ–é¼ æ ‡ä¸­é”®æ‹–åŠ¨ç”»å¸ƒå¯ä»¥å¹³ç§»è§†å›¾</li>
                            <li>ä½¿ç”¨é¼ æ ‡æ»šè½®å¯ä»¥ç¼©æ”¾è§†å›¾</li>
                            <li>ä½¿ç”¨æ–¹å‘é”®å¯ä»¥å¾®è°ƒè§†å›¾ä½ç½®</li>
                            <li>æŒ‰Homeé”®é‡ç½®è§†å›¾</li>
                        </ul>
                    </li>
                    <li><strong>å¯é€‰åŠŸèƒ½ï¼š</strong>ä¸Šä¼ Bå›¾ç‰‡å¯åœ¨ç”Ÿæˆè§†é¢‘æ—¶æ›¿æ¢èƒŒæ™¯ï¼Œå®ç°å¯¹è±¡ç§»é™¤æ•ˆæœ</li>
                </ul>
            </div>
            
            <!-- è§†é¢‘é¢„è§ˆåŒºåŸŸ -->
            <div class="video-preview" id="dl4VideoPreview">
                <h3>ç”Ÿæˆçš„è§†é¢‘</h3>
                <video id="resultDrawLine4Video" controls></video>
                <div style="margin-top: 15px;">
                    <a id="downloadDL4Video" class="btn-success" download="generated_video.webm">ä¸‹è½½è§†é¢‘</a>
                </div>
            </div>
            
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar" id="statusBar">
                å°±ç»ªã€‚è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å¹¶æ‰“å¼€ç”»å¸ƒã€‚
            </div>
        </div>
        
        <div class="footer">
            <p>è§†é¢‘æ§åˆ¶ç”»çº¿å·¥å…· | åŸºäºCanvaså’ŒMediaRecorderæŠ€æœ¯</p>
            <p style="font-size: 12px; margin-top: 5px;">æç¤ºï¼šéƒ¨åˆ†åŠŸèƒ½éœ€è¦ç°ä»£æµè§ˆå™¨æ”¯æŒï¼ˆChrome 65+, Firefox 63+, Edge 79+ï¼‰</p>
        </div>
    </div>
    
    <!-- éšè—çš„è¾“å…¥æ¡†ï¼Œç”¨äºå­˜å‚¨å›¾ç‰‡è·¯å¾„ -->
    <input type="hidden" id="t2videoEditPath" value="">
    
    <script>
        // å…¨å±€å˜é‡
        let editImage = null; // å­˜å‚¨Bå›¾ç‰‡
        
        $(document).ready(function() {
            // åˆå§‹åŒ–EasyUIç»„ä»¶
            $('#t2video_dl4v_replacePrompt').textbox();
            $('#t2video_dl4v_duration').slider();
            $('#t2video_dl4v_reset').linkbutton();
            $('#t2video_dl4v_set').linkbutton();
            $('#t2video_dl4v_ok').linkbutton();
            
            // æ›´æ–°çŠ¶æ€æ 
            function updateStatus(message, type = 'info') {
                const statusBar = $('#statusBar');
                statusBar.text(message);
                
                if (type === 'error') {
                    statusBar.css('background-color', '#ffeaea');
                    statusBar.css('color', '#e74c3c');
                } else if (type === 'success') {
                    statusBar.css('background-color', '#eaffea');
                    statusBar.css('color', '#27ae60');
                } else {
                    statusBar.css('background-color', '#f8f9fa');
                    statusBar.css('color', '#555');
                }
                
                console.log('çŠ¶æ€:', message);
            }
            
            let canvasBackgroundImage = null; // å­˜å‚¨Aå›¾ç‰‡
            let canvasBackgroundImageUrl = null; // å­˜å‚¨Aå›¾ç‰‡çš„URL
            
            // æ¨¡æ‹Ÿæ¶ˆæ¯æç¤ºå‡½æ•°
            function centerMsg(message, type) {
                alert(`${type === 'error' ? 'é”™è¯¯' : 'è­¦å‘Š'}: ${message}`);
                updateStatus(message, type);
            }
            
            function slideMsg(message) {
                console.log('æ¶ˆæ¯:', message);
                updateStatus(message, 'success');
            }
            
            // å›¾ç‰‡ä¸Šä¼ å¤„ç†å‡½æ•°
            function setupImageUpload(uploadBoxId, fileInputId, previewId, infoId, isBgImage = false) {
                const uploadBox = $(`#${uploadBoxId}`);
                const fileInput = $(`#${fileInputId}`);
                const preview = $(`#${previewId}`);
                const info = $(`#${infoId}`);
                
                
                // æ‹–æ”¾åŠŸèƒ½
                uploadBox.on('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadBox.css('border-color', '#3498db');
                    uploadBox.css('background-color', '#f0f7ff');
                });
                
                uploadBox.on('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadBox.css('border-color', '#bdc3c7');
                    uploadBox.css('background-color', 'white');
                });
                
                uploadBox.on('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadBox.css('border-color', '#bdc3c7');
                    uploadBox.css('background-color', 'white');
                    
                    const files = e.originalEvent.dataTransfer.files;
                    if (files.length > 0) {
                        handleImageFile(files[0], isBgImage);
                    }
                });
                
                // æ–‡ä»¶é€‰æ‹©å˜åŒ–
                fileInput.on('change', function(e) {
                    if (this.files && this.files[0]) {
                        handleImageFile(this.files[0], isBgImage);
                    }
                });
                
                function handleImageFile(file, isBackground) {
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.type.match('image.*')) {
                        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                        return;
                    }
                    
                    // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                    const fileName = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
                    info.html(`<strong>å·²é€‰æ‹©:</strong> ${fileName} (${(file.size / 1024).toFixed(1)} KB)`);
                    info.show();
                    
                    // åˆ›å»ºé¢„è§ˆ
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.attr('src', e.target.result);
                        preview.show();
                        
                        // åˆ›å»ºå›¾ç‰‡å¯¹è±¡
                        const img = new Image();
                        img.onload = function() {
                            if (isBackground) {
                                canvasBackgroundImage = img;
                                canvasBackgroundImageUrl = e.target.result;
                                $('#useBgImageBtn').show();
                                updateStatus(`èƒŒæ™¯å›¾ç‰‡å·²åŠ è½½: ${img.width}Ã—${img.height} åƒç´ `, 'success');
                            } else {
                                editImage = img;
                                $('#editImageStatus').html(`<span style="color: #27ae60;">âœ“ ç¼–è¾‘å›¾ç‰‡å·²åŠ è½½: ${img.width}Ã—${img.height} åƒç´ </span>`);
                                updateStatus(`ç¼–è¾‘å›¾ç‰‡å·²åŠ è½½ï¼Œå°†åœ¨ç”Ÿæˆè§†é¢‘æ—¶ä½¿ç”¨`, 'success');
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ 
            setupImageUpload('bgImageUpload', 'bgImageInput', 'bgImagePreview', 'bgImageInfo', true);
            setupImageUpload('editImageUpload', 'editImageInput', 'editImagePreview', 'editImageInfo', false);
            
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            $("#bgImageUpload").on('click', function() {
                //fileInput.click();
                $("#bgImageInput").trigger("click");
            });
            
            $("#editImageUpload").on('click', function() {
                //fileInput.click();
                $("#editImageInput").trigger("click");
            });
            
            // ä½¿ç”¨èƒŒæ™¯å›¾ç‰‡æŒ‰é’®
            $('#useBgImageBtn').on('click', function() {
                if (!canvasBackgroundImage) {
                    alert('è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾ç‰‡ï¼');
                    return;
                }
                updateStatus('èƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®ï¼Œå¯ä»¥æ‰“å¼€ç”»å¸ƒäº†', 'success');
            });
            
            // æ‰“å¼€ç”»å¸ƒæŒ‰é’®
            $('#openCanvasBtn').on('click', function() {
                if (!canvasBackgroundImage) {
                    alert('è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å¹¶ç‚¹å‡»"ä½¿ç”¨æ­¤å›¾ç‰‡ä½œä¸ºèƒŒæ™¯"æŒ‰é’®ï¼');
                    return;
                }
                
                // è°ƒç”¨control4Videoå‡½æ•°
                control4Video('demo_video', canvasBackgroundImageUrl);
                $('#clearCanvasBtn').show();
                updateStatus('ç”»å¸ƒå·²æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹ç»˜åˆ¶çŸ©å½¢', 'success');
            });
            
            // æ¸…ç©ºç”»å¸ƒæŒ‰é’®
            $('#clearCanvasBtn').on('click', function() {
                $('.t2i-fill-mask-layer').remove();
                updateStatus('ç”»å¸ƒå·²å…³é—­', 'info');
                $(this).hide();
            });
        });
        
        // control4Videoå‡½æ•° - ä¸»åŠŸèƒ½
        function control4Video(video_id, img_path_in) {
            /********************************************************************** ç”»çº¿å±‚ *********************************************************************/
            let dragger_box;
            let original_width = 0;
            let original_height = 0;

            const body = $('body'); 
            const mask = $('<div class="t2i-fill-mask-layer">')
                .appendTo(body)
                .on('click', function(e) {
                    if (e.target === this) {
                        $('#t2video_edit_dl4v_toolbar_pool').appendTo($('#w_t2i_edit')).css({'display': 'none'});
                        document.getElementById('t2video_dl4v_reset').removeEventListener('click', resetCanvas);
                        document.getElementById('t2video_dl4v_set').removeEventListener('click', startRecording);
                        document.getElementById('t2video_dl4v_ok').removeEventListener('click', stopRecording);
                        $(this).remove();
                        $('#clearCanvasBtn').hide();
                        $('#statusBar').text('ç”»å¸ƒå·²å…³é—­');
                    }
                });
            
            let toolbar = $('#t2video_edit_dl4v_toolbar_pool')
                .appendTo(mask)
                .css({
                    'width': '100%',
                    'height': 'auto',
                    'background-color': 'white',
                    'position': 'absolute',
                    'top': '0px',
                    'left': '50%',
                    'transform': 'translateX(-50%)',
                    'display': 'block',
                    'z-index': 10001,
                    'padding': '10px',
                    'box-shadow': '0 2px 10px rgba(0,0,0,0.2)'
                }); 
            
            // å…ˆåˆ›å»ºcanvaså®¹å™¨ï¼Œç¨åè®¾ç½®å…·ä½“å°ºå¯¸
            let canvasContainer = $('<div id="t2videoCanvasContainer" style="text-align: center; margin-top: 50px; overflow: visible;"></div>').appendTo(mask);
            let cache_canvas = $('<canvas id="t2videoControlCanvas"></canvas>').appendTo(canvasContainer);
            
            /********************************************************************** ç”»çº¿ *********************************************************************/
            const canvas = document.getElementById('t2videoControlCanvas');
            const ctx = canvas.getContext('2d');
            
            let rectangles = [];
            let selectedRectIndex = -1;
            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            let isRecording = false;
            let isDrawing = false;
            let drawingStartX, drawingStartY;
            let currentDrawingRect = null;
            
            let backgroundImage = null;
            let viewOffsetX = 0; // è§†å›¾åç§»é‡
            let viewOffsetY = 0;
            let isPanning = false;
            let panStartX, panStartY;
            
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', 
                '#98D8C8', '#F78FB3', '#F8EFBA', '#9B59B6'
            ];

            $('#downloadDL4Video').off('click');
            $('#downloadDL4Video').click(function() {
                console.log('ä¸‹è½½è§†é¢‘...');
            });
            
            function init() {
                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', handleMouseUp);
                canvas.addEventListener('mouseout', handleMouseUp);
                canvas.addEventListener('wheel', handleMouseWheel);
                
                // æ·»åŠ é”®ç›˜äº‹ä»¶ç”¨äºå¹³ç§»è§†å›¾
                document.addEventListener('keydown', handleKeyDown);
                
                document.getElementById('t2video_dl4v_reset').addEventListener('click', resetCanvas);
                document.getElementById('t2video_dl4v_set').addEventListener('click', startRecording);
                document.getElementById('t2video_dl4v_ok').addEventListener('click', stopRecording);
                
                loadImage();
            }
            
            function loadImage() {
                backgroundImage = new Image();
                backgroundImage.onload = function() {
                    // è®¾ç½®canvaså°ºå¯¸ä¸å›¾ç‰‡ä¿æŒä¸€è‡´
                    canvas.width = backgroundImage.width;
                    canvas.height = backgroundImage.height;
                    
                    // æ›´æ–°canvasæ ·å¼ï¼Œè®¾ç½®æœ€å¤§å®½åº¦å’Œé«˜åº¦ä»¥é˜²æ­¢è¿‡å¤§
                    const maxWidth = 1200;
                    const maxHeight = 760;
                    
                    let width = backgroundImage.width;
                    let height = backgroundImage.height;
                    
                    // å¦‚æœå›¾ç‰‡å°ºå¯¸è¶…è¿‡æœ€å¤§å€¼ï¼Œç­‰æ¯”ä¾‹ç¼©æ”¾
                    if (width > maxWidth || height > maxHeight) {
                        const widthRatio = maxWidth / width;
                        const heightRatio = maxHeight / height;
                        const scale = Math.min(widthRatio, heightRatio);
                        
                        width = Math.floor(width * scale);
                        height = Math.floor(height * scale);
                    }
                    
                    $(canvas).css({
                        'width': width + 'px',
                        'height': height + 'px',
                        'border': '1px solid #ddd',
                        'box-shadow': '0 2px 10px rgba(0,0,0,0.1)',
                        'cursor': 'grab'
                    });
                    
                    drawCanvas();
                    $('#statusBar').text('ç”»å¸ƒå·²æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹ç»˜åˆ¶çŸ©å½¢');
                };
                backgroundImage.onerror = function() {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', img_path_in);
                    // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å°ºå¯¸
                    canvas.width = 800;
                    canvas.height = 600;
                    drawCanvas();
                };
                backgroundImage.src = img_path_in;
            }
            
            // æˆªå–å›¾ç‰‡åŒºåŸŸä½œä¸ºçŸ©å½¢èƒŒæ™¯
            function captureImageArea(rect) {
                if (!backgroundImage) return null;
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶canvasæ¥æˆªå–å›¾ç‰‡åŒºåŸŸ
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // ç”±äºcanvasä¸å›¾ç‰‡å°ºå¯¸ä¸€è‡´ï¼Œç›´æ¥ä½¿ç”¨çŸ©å½¢åæ ‡
                const sourceX = rect.x;
                const sourceY = rect.y;
                const sourceWidth = rect.width;
                const sourceHeight = rect.height;
                
                // ç¡®ä¿ä¸è¶…å‡ºå›¾ç‰‡è¾¹ç•Œ
                const safeSourceX = Math.max(0, Math.min(sourceX, backgroundImage.width - 1));
                const safeSourceY = Math.max(0, Math.min(sourceY, backgroundImage.height - 1));
                const safeSourceWidth = Math.max(1, Math.min(sourceWidth, backgroundImage.width - safeSourceX));
                const safeSourceHeight = Math.max(1, Math.min(sourceHeight, backgroundImage.height - safeSourceY));
                
                // è®¾ç½®ä¸´æ—¶canvaså°ºå¯¸
                tempCanvas.width = safeSourceWidth;
                tempCanvas.height = safeSourceHeight;
                
                // ç»˜åˆ¶æˆªå–çš„åŒºåŸŸ
                tempCtx.drawImage(
                    backgroundImage,
                    safeSourceX, safeSourceY, safeSourceWidth, safeSourceHeight,
                    0, 0, safeSourceWidth, safeSourceHeight
                );
                
                // åˆ›å»ºæ–°çš„Imageå¯¹è±¡
                const croppedImage = new Image();
                croppedImage.src = tempCanvas.toDataURL();
                return croppedImage;
            }
            
            function handleMouseDown(e) {
                const rectCanvas = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rectCanvas.width;
                const scaleY = canvas.height / rectCanvas.height;
                
                const mouseX = (e.clientX - rectCanvas.left) * scaleX;
                const mouseY = (e.clientY - rectCanvas.top) * scaleY;
                
                // æŒ‰ä¸‹ç©ºæ ¼é”®æˆ–ä¸­é”®æ—¶å¼€å§‹å¹³ç§»
                if (e.ctrlKey || e.button === 1) { // Ctrlé”®æˆ–ä¸­é”®
                    isPanning = true;
                    panStartX = mouseX + viewOffsetX;
                    panStartY = mouseY + viewOffsetY;
                    $(canvas).css('cursor', 'grabbing');
                    return;
                }
                
                // è°ƒæ•´é¼ æ ‡åæ ‡ä¸ºè€ƒè™‘è§†å›¾åç§»
                const adjustedMouseX = mouseX + viewOffsetX;
                const adjustedMouseY = mouseY + viewOffsetY;
                
                // æ£€æŸ¥ç‚¹å‡»äº†å“ªä¸ªçŸ©å½¢ï¼ˆä»åå¾€å‰æ£€æŸ¥ï¼‰
                for (let i = rectangles.length - 1; i >= 0; i--) {
                    const rect = rectangles[i];
                    if (adjustedMouseX >= rect.x && adjustedMouseX <= rect.x + rect.width && 
                        adjustedMouseY >= rect.y && adjustedMouseY <= rect.y + rect.height) {
                        
                        selectedRectIndex = i;
                        isDragging = true;
                        dragOffsetX = adjustedMouseX - rect.x;
                        dragOffsetY = adjustedMouseY - rect.y;
                        
                        // å½•åˆ¶æ—¶è®°å½•è½¨è¿¹èµ·ç‚¹
                        if (isRecording) {
                            rect.trajectory.push({
                                x: rect.x,
                                y: rect.y,
                                width: rect.width,
                                height: rect.height,
                                timestamp: Date.now()
                            });
                        }
                        
                        drawCanvas();
                        return;
                    }
                }
                
                // æ²¡æœ‰ç‚¹å‡»ä»»ä½•çŸ©å½¢ï¼Œå¼€å§‹ç»˜åˆ¶æ–°çŸ©å½¢
                isDrawing = true;
                drawingStartX = adjustedMouseX;
                drawingStartY = adjustedMouseY;
                
                // åˆ›å»ºä¸´æ—¶ç»˜åˆ¶çŸ©å½¢
                currentDrawingRect = {
                    x: adjustedMouseX,
                    y: adjustedMouseY,
                    width: 0,
                    height: 0,
                    color: colors[rectangles.length % colors.length],
                    backgroundImage: null
                };
            }
            
            function handleMouseMove(e) {
                const rectCanvas = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rectCanvas.width;
                const scaleY = canvas.height / rectCanvas.height;
                
                const mouseX = (e.clientX - rectCanvas.left) * scaleX;
                const mouseY = (e.clientY - rectCanvas.top) * scaleY;
                
                // å¤„ç†å¹³ç§»è§†å›¾
                if (isPanning) {
                    viewOffsetX = panStartX - mouseX;
                    viewOffsetY = panStartY - mouseY;
                    drawCanvas();
                    return;
                }
                
                // è°ƒæ•´é¼ æ ‡åæ ‡ä¸ºè€ƒè™‘è§†å›¾åç§»
                const adjustedMouseX = mouseX + viewOffsetX;
                const adjustedMouseY = mouseY + viewOffsetY;
                
                if (isDragging && selectedRectIndex !== -1) {
                    const rect = rectangles[selectedRectIndex];
                    rect.x = adjustedMouseX - dragOffsetX;
                    rect.y = adjustedMouseY - dragOffsetY;
                    
                    // ç§»é™¤è¾¹ç•Œé™åˆ¶ï¼Œå…è®¸çŸ©å½¢è‡ªç”±ç§»åŠ¨
                    // ä¸é™åˆ¶çŸ©å½¢ç§»åŠ¨èŒƒå›´
                    
                    // å½•åˆ¶æ—¶è®°å½•è½¨è¿¹
                    if (isRecording) {
                        rect.trajectory.push({
                            x: rect.x,
                            y: rect.y,
                            width: rect.width,
                            height: rect.height,
                            timestamp: Date.now()
                        });
                    }
                    
                    drawCanvas();
                } else if (isDrawing && currentDrawingRect) {
                    // æ›´æ–°ä¸´æ—¶ç»˜åˆ¶çŸ©å½¢
                    currentDrawingRect.width = adjustedMouseX - drawingStartX;
                    currentDrawingRect.height = adjustedMouseY - drawingStartY;
                    
                    // ç¡®ä¿å®½åº¦å’Œé«˜åº¦ä¸ºæ­£æ•°
                    if (currentDrawingRect.width < 0) {
                        currentDrawingRect.x = adjustedMouseX;
                        currentDrawingRect.width = -currentDrawingRect.width;
                    }
                    if (currentDrawingRect.height < 0) {
                        currentDrawingRect.y = adjustedMouseY;
                        currentDrawingRect.height = -currentDrawingRect.height;
                    }
                    
                    drawCanvas();
                }
            }
            
            function handleMouseUp(e) {
                if (isPanning) {
                    isPanning = false;
                    $(canvas).css('cursor', 'grab');
                } else if (isDragging) {
                    isDragging = false;
                } else if (isDrawing && currentDrawingRect) {
                    const rectCanvas = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rectCanvas.width;
                    const scaleY = canvas.height / rectCanvas.height;
                    
                    const mouseX = (e.clientX - rectCanvas.left) * scaleX;
                    const mouseY = (e.clientY - rectCanvas.top) * scaleY;
                    
                    // è°ƒæ•´é¼ æ ‡åæ ‡ä¸ºè€ƒè™‘è§†å›¾åç§»
                    const adjustedMouseX = mouseX + viewOffsetX;
                    const adjustedMouseY = mouseY + viewOffsetY;
                    
                    const width = Math.abs(adjustedMouseX - drawingStartX);
                    const height = Math.abs(adjustedMouseY - drawingStartY);
                    
                    const x = Math.min(drawingStartX, adjustedMouseX);
                    const y = Math.min(drawingStartY, adjustedMouseY);
                    
                    // æ·»åŠ æ–°çŸ©å½¢ï¼ˆæœ€å°å°ºå¯¸ä¸º5pxï¼‰
                    if (width > 5 && height > 5) {
                        const newRect = {
                            x,
                            y,
                            width,
                            height,
                            color: colors[rectangles.length % colors.length],
                            trajectory: [],
                            backgroundImage: null // åˆå§‹åŒ–èƒŒæ™¯å›¾ç‰‡
                        };
                        
                        // åªåœ¨åˆ›å»ºæ—¶æˆªå–ä¸€æ¬¡å›¾ç‰‡ä½œä¸ºèƒŒæ™¯
                        newRect.backgroundImage = captureImageArea(newRect);
                        
                        rectangles.push(newRect);
                    }
                    
                    isDrawing = false;
                    currentDrawingRect = null;
                    drawCanvas();
                }
            }
            
            function handleMouseWheel(e) {
                e.preventDefault();
                
                // ä½¿ç”¨æ»šè½®ç¼©æ”¾è§†å›¾
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                
                // è®¡ç®—ç¼©æ”¾å‰åçš„åæ ‡å˜åŒ–
                const rectCanvas = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rectCanvas.width;
                const scaleY = canvas.height / rectCanvas.height;
                
                const mouseX = (e.clientX - rectCanvas.left) * scaleX;
                const mouseY = (e.clientY - rectCanvas.top) * scaleY;
                
                // è°ƒæ•´è§†å›¾åç§»ä»¥å®ç°ç¼©æ”¾æ•ˆæœ
                viewOffsetX = viewOffsetX + mouseX * delta;
                viewOffsetY = viewOffsetY + mouseY * delta;
                
                drawCanvas();
            }
            
            function handleKeyDown(e) {
                // ä½¿ç”¨æ–¹å‘é”®å¹³ç§»è§†å›¾
                const step = 20;
                
                switch(e.key) {
                    case 'ArrowLeft':
                        viewOffsetX += step;
                        break;
                    case 'ArrowRight':
                        viewOffsetX -= step;
                        break;
                    case 'ArrowUp':
                        viewOffsetY += step;
                        break;
                    case 'ArrowDown':
                        viewOffsetY -= step;
                        break;
                    case 'Home':
                        // é‡ç½®è§†å›¾
                        viewOffsetX = 0;
                        viewOffsetY = 0;
                        break;
                }
                
                drawCanvas();
            }
            
            // ç»˜åˆ¶Canvas
            function drawCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ä¿å­˜å½“å‰çŠ¶æ€
                ctx.save();
                
                // åº”ç”¨è§†å›¾åç§»ï¼ˆå¹³ç§»ï¼‰
                ctx.translate(-viewOffsetX, -viewOffsetY);
                
                // ç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡ï¼ˆä»0,0å¼€å§‹ï¼‰
                if (backgroundImage) {
                    ctx.drawImage(
                        backgroundImage, 
                        0, 
                        0, 
                        canvas.width, 
                        canvas.height
                    );
                } else {
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
                    drawGrid();
                }
                
                // ç»˜åˆ¶æ‰€æœ‰çŸ©å½¢
                rectangles.forEach((rect, index) => {
                    // å¦‚æœæœ‰èƒŒæ™¯å›¾ç‰‡ï¼Œç»˜åˆ¶èƒŒæ™¯å›¾ç‰‡
                    if (rect.backgroundImage && rect.backgroundImage.complete) {
                        // å¡«å……çŸ©å½¢èƒŒæ™¯ä¸ºæˆªå–çš„å›¾ç‰‡
                        ctx.drawImage(
                            rect.backgroundImage,
                            rect.x, rect.y, rect.width, rect.height
                        );
                    } else {
                        // å¦åˆ™ä½¿ç”¨åŠé€æ˜é¢œè‰²
                        ctx.fillStyle = rect.color + '80';
                        ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    }
                    
                    // ç»˜åˆ¶è¾¹æ¡†
                    ctx.strokeStyle = index === selectedRectIndex ? '#FFD166' : 'rgba(255, 255, 255, 0.7)';
                    ctx.lineWidth = index === selectedRectIndex ? 3 : 2;
                    ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
                    
                    // ç»˜åˆ¶ä¸­å¿ƒç‚¹
                    ctx.fillStyle = '#EF476F';
                    ctx.beginPath();
                    ctx.arc(rect.x + rect.width/2, rect.y + rect.height/2, 5, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // ç»˜åˆ¶å½“å‰æ­£åœ¨ç»˜åˆ¶çš„çŸ©å½¢
                if (isDrawing && currentDrawingRect) {
                    ctx.fillStyle = currentDrawingRect.color + '80';
                    ctx.fillRect(
                        currentDrawingRect.x, 
                        currentDrawingRect.y, 
                        currentDrawingRect.width, 
                        currentDrawingRect.height
                    );
                    
                    ctx.strokeStyle = '#FFD166';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(
                        currentDrawingRect.x, 
                        currentDrawingRect.y, 
                        currentDrawingRect.width, 
                        currentDrawingRect.height
                    );
                }
                
                // ç»˜åˆ¶è½¨è¿¹ï¼ˆå½•åˆ¶æ—¶æ˜¾ç¤ºï¼‰
                if (isRecording) {
                    rectangles.forEach(rect => {
                        if (rect.trajectory.length > 1) {
                            ctx.beginPath();
                            ctx.moveTo(
                                rect.trajectory[0].x + rect.trajectory[0].width/2, 
                                rect.trajectory[0].y + rect.trajectory[0].height/2
                            );
                            
                            for (let i = 1; i < rect.trajectory.length; i++) {
                                ctx.lineTo(
                                    rect.trajectory[i].x + rect.trajectory[i].width/2, 
                                    rect.trajectory[i].y + rect.trajectory[i].height/2
                                );
                            }
                            
                            ctx.strokeStyle = rect.color;
                            ctx.lineWidth = 3;
                            ctx.stroke();
                        }
                    });
                }
                
                // æ¢å¤çŠ¶æ€
                ctx.restore();
                
                // ç»˜åˆ¶è§†å›¾è¾¹ç•ŒæŒ‡ç¤ºå™¨
                drawViewBoundary();
            }
            
            // ç»˜åˆ¶ç½‘æ ¼
            function drawGrid() {
                // å› ä¸ºåº”ç”¨äº†å¹³ç§»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ•´ä¸ªå¯è§åŒºåŸŸç»˜åˆ¶ç½‘æ ¼
                const extendedWidth = canvas.width * 3;
                const extendedHeight = canvas.height * 3;
                const startX = -extendedWidth / 2;
                const startY = -extendedHeight / 2;
                
                ctx.strokeStyle = 'rgba(100, 100, 150, 0.2)';
                ctx.lineWidth = 1;
                
                for (let x = startX; x <= startX + extendedWidth; x += 20) {
                    ctx.beginPath();
                    ctx.moveTo(x, startY);
                    ctx.lineTo(x, startY + extendedHeight);
                    ctx.stroke();
                }
                
                for (let y = startY; y <= startY + extendedHeight; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(startX, y);
                    ctx.lineTo(startX + extendedWidth, y);
                    ctx.stroke();
                }
            }
            
            // ç»˜åˆ¶è§†å›¾è¾¹ç•ŒæŒ‡ç¤ºå™¨
            function drawViewBoundary() {
                // ç»˜åˆ¶åŠé€æ˜çš„è¾¹ç•Œæ¡†ï¼Œè¡¨ç¤ºåŸå§‹canvasèŒƒå›´
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
                ctx.setLineDash([]);
                
                // åœ¨è§’è½æ·»åŠ æ–‡æœ¬æç¤º
                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                ctx.font = '12px Arial';
                ctx.fillText('è§†å›¾è¾¹ç•Œ', 10, 20);
                
                // æ˜¾ç¤ºå½“å‰è§†å›¾åç§»
                ctx.fillText(`åç§»: (${Math.round(viewOffsetX)}, ${Math.round(viewOffsetY)})`, 10, 40);
            }
            
            // é‡ç½®ç”»å¸ƒ
            function resetCanvas() {
                rectangles = [];
                selectedRectIndex = -1;
                isRecording = false;
                viewOffsetX = 0;
                viewOffsetY = 0;
                $('#t2video_dl4v_reset').linkbutton('disable');
                drawCanvas();
                $('#statusBar').text('ç”»å¸ƒå·²é‡ç½®');
            }
            
            // å¼€å§‹å½•åˆ¶è½¨è¿¹
            function startRecording() {
                if (rectangles.length === 0) {
                    alert("è¯·å…ˆç»˜åˆ¶è‡³å°‘ä¸€ä¸ªçŸ©å½¢ï¼");
                    $('#statusBar').text('é”™è¯¯ï¼šè¯·å…ˆç»˜åˆ¶è‡³å°‘ä¸€ä¸ªçŸ©å½¢ï¼');
                    return;
                }
                
                // é‡ç½®æ‰€æœ‰è½¨è¿¹
                rectangles.forEach(rect => rect.trajectory = []);
                
                isRecording = true;
                $('#t2video_dl4v_reset').linkbutton('enable');
                $('#statusBar').text('æ­£åœ¨å½•åˆ¶è½¨è¿¹... æ‹–åŠ¨çŸ©å½¢ä»¥åˆ›å»ºè¿åŠ¨è·¯å¾„');
            }
            
            // åœæ­¢å½•åˆ¶å¹¶ç”Ÿæˆè§†é¢‘
            function stopRecording() {
                isRecording = false;
                $('#t2video_dl4v_reset').linkbutton('enable');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è½¨è¿¹
                let hasTrajectory = false;
                rectangles.forEach(rect => {
                    if (rect.trajectory.length > 0) hasTrajectory = true;
                });
                
                if (!hasTrajectory) {
                    alert("æ²¡æœ‰è¿åŠ¨è½¨è¿¹");
                    $('#statusBar').text('è­¦å‘Šï¼šæ²¡æœ‰è¿åŠ¨è½¨è¿¹ï¼Œè¯·å…ˆå½•åˆ¶è½¨è¿¹');
                    return;
                }
                
                $('#statusBar').text('æ­£åœ¨ç”Ÿæˆè§†é¢‘...');
                
                // ç›´æ¥ç”Ÿæˆè§†é¢‘ï¼Œä½¿ç”¨Bå›¾ç‰‡ä½œä¸ºedit_imgå‚æ•°
                generateTransparentVideo(editImage || null);
            }
            
            // ç”Ÿæˆé€æ˜èƒŒæ™¯è§†é¢‘
            function generateTransparentVideo(edit_img) {
                const offscreenCanvas = document.createElement('canvas');
                // è®¾ç½®offscreenCanvaså°ºå¯¸ä¸åŸå§‹canvasä¸€è‡´ï¼ˆè§†é¢‘è¾“å‡ºå°ºå¯¸ï¼‰
                offscreenCanvas.width = canvas.width;
                offscreenCanvas.height = canvas.height;
                const offscreenCtx = offscreenCanvas.getContext('2d', { willReadFrequently: true });
                
                // åˆ›å»ºåª’ä½“æµ
                const stream = offscreenCanvas.captureStream(16);
                const recordedChunks = [];
                
                // é…ç½®MediaRecorder
                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9',
                    videoBitsPerSecond: 2500000
                });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(blob);                
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    const videoPreview = document.getElementById('dl4VideoPreview');
                    const resultVideo = document.getElementById('resultDrawLine4Video');
                    const downloadLink = document.getElementById('downloadDL4Video');
                    
                    resultVideo.src = videoUrl;
                    downloadLink.href = videoUrl;
                    downloadLink.download = 'generated_video_' + Date.now() + '.webm';
                    
                    videoPreview.style.display = 'block';
                    downloadLink.style.display = 'block';
                    
                    // è®¡ç®—è½¨è¿¹ç‚¹æ€»æ•°
                    let totalPoints = 0;
                    rectangles.forEach(rect => totalPoints += rect.trajectory.length);
                    
                    $('#statusBar').text('è§†é¢‘ç”Ÿæˆå®Œæˆï¼å¯ä¸‹è½½æˆ–æ’­æ”¾é¢„è§ˆ');
                    alert('è§†é¢‘ç”Ÿæˆå®Œæˆï¼');
                };
                
                mediaRecorder.start();
                            
                let dl4v_duration = $('#t2video_dl4v_duration').slider('getValue');    

                // åŠ¨ç”»å‚æ•°
                const duration = parseInt(dl4v_duration)*1000; // åŠ¨ç”»æ—¶é•¿
                const startTime = Date.now();
                
                // è®¡ç®—æ¯ä¸ªçŸ©å½¢çš„é€Ÿåº¦
                rectangles.forEach(rect => {
                    if (rect.trajectory.length > 1) {
                        // è®¡ç®—çŸ©å½¢ç§»åŠ¨çš„æ€»è·ç¦»ï¼ˆåƒç´ ï¼‰
                        let totalDistance = 0;
                        for (let i = 1; i < rect.trajectory.length; i++) {
                            const prev = rect.trajectory[i-1];
                            const curr = rect.trajectory[i];
                            // è®¡ç®—ä¸­å¿ƒç‚¹ä¹‹é—´çš„æ¬§å‡ é‡Œå¾—è·ç¦»
                            const dx = (curr.x + curr.width/2) - (prev.x + prev.width/2);
                            const dy = (curr.y + curr.height/2) - (prev.y + prev.height/2);
                            totalDistance += Math.sqrt(dx*dx + dy*dy);
                        }
                        // è®¡ç®—åƒç´ /æ¯«ç§’çš„é€Ÿåº¦
                        rect.speed = totalDistance / duration;
                    } else {
                        rect.speed = 0; // æ²¡æœ‰ç§»åŠ¨
                    }
                });
                
                // åŠ¨ç”»å‡½æ•°
                function animate() {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // æ¸…é™¤ç”»å¸ƒå¹¶è®¾ç½®ç™½è‰²èƒŒæ™¯
                    offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);

                    // ç»˜åˆ¶èƒŒæ™¯
                    // å¦‚æœå­˜åœ¨ç¼–è¾‘å›¾ç‰‡ï¼Œä½¿ç”¨å®ƒä½œä¸ºèƒŒæ™¯
                    if (edit_img) {
                        //console.log("ä½¿ç”¨æŒ‡å®šå›¾ç‰‡ä½œä¸ºèƒŒæ™¯å›¾ç‰‡a");
                        // ä½¿ç”¨Bå›¾ç‰‡ä½œä¸ºèƒŒæ™¯
                        offscreenCtx.drawImage(edit_img, 0, 0, offscreenCanvas.width, offscreenCanvas.height);
                    } else {
                        //console.log("ä½¿ç”¨æŒ‡å®šå›¾ç‰‡ä½œä¸ºèƒŒæ™¯å›¾ç‰‡b");
                        // å¦åˆ™ä½¿ç”¨åŸå§‹èƒŒæ™¯å›¾ç‰‡
                        offscreenCtx.fillStyle = 'white';
                        offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                        
                        if (backgroundImage && backgroundImage.complete && backgroundImage.naturalWidth > 0) {
                            offscreenCtx.drawImage(
                                backgroundImage, 
                                0, 
                                0, 
                                offscreenCanvas.width, 
                                offscreenCanvas.height
                            );
                        }
                    }
                    
                    // ç»˜åˆ¶æ‰€æœ‰çŸ©å½¢
                    rectangles.forEach(rect => {
                        if (rect.trajectory.length === 0) return;
                        
                        // è®¡ç®—å½“å‰çŸ©å½¢åº”ç§»åŠ¨çš„æ€»è·ç¦»
                        const distanceTraveled = elapsed * rect.speed;
                        
                        // æŸ¥æ‰¾å½“å‰ä½ç½®
                        let accumulatedDistance = 0;
                        let currentIndex = 0;
                        let frame;
                        
                        // å¯¹äºé™æ­¢çš„çŸ©å½¢
                        if (rect.speed === 0) {
                            frame = rect.trajectory[0];
                        } 
                        // å¯¹äºç§»åŠ¨çš„çŸ©å½¢
                        else {
                            // æ‰¾åˆ°å½“å‰è·ç¦»å¯¹åº”çš„è½¨è¿¹æ®µ
                            for (let i = 1; i < rect.trajectory.length; i++) {
                                const prev = rect.trajectory[i-1];
                                const curr = rect.trajectory[i];
                                
                                // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»
                                const dx = (curr.x + curr.width/2) - (prev.x + prev.width/2);
                                const dy = (curr.y + curr.height/2) - (prev.y + prev.height/2);
                                const segmentDistance = Math.sqrt(dx*dx + dy*dy);
                                
                                // å¦‚æœç´¯è®¡è·ç¦»è¶…è¿‡å·²ç§»åŠ¨è·ç¦»ï¼Œåˆ™æ‰¾åˆ°å½“å‰æ®µ
                                if (accumulatedDistance + segmentDistance >= distanceTraveled) {
                                    const segmentProgress = (distanceTraveled - accumulatedDistance) / segmentDistance;
                                    
                                    // çº¿æ€§æ’å€¼è®¡ç®—å½“å‰ä½ç½®
                                    frame = {
                                        x: prev.x + (curr.x - prev.x) * segmentProgress,
                                        y: prev.y + (curr.y - prev.y) * segmentProgress,
                                        width: prev.width + (curr.width - prev.width) * segmentProgress,
                                        height: prev.height + (curr.height - prev.height) * segmentProgress
                                    };
                                    currentIndex = i;
                                    break;
                                }
                                
                                accumulatedDistance += segmentDistance;
                                
                                // å¦‚æœåˆ°è¾¾æœ€åä¸€ç‚¹
                                if (i === rect.trajectory.length - 1) {
                                    frame = curr;
                                }
                            }
                        }
                        
                        // ç»˜åˆ¶çŸ©å½¢ï¼ˆåªç»˜åˆ¶åœ¨canvaså†…çš„éƒ¨åˆ†ï¼‰
                        if (frame) {
                            // æ£€æŸ¥çŸ©å½¢æ˜¯å¦åœ¨canvaså†…ï¼ˆè‡³å°‘éƒ¨åˆ†åœ¨ï¼‰
                            const isVisible = frame.x < offscreenCanvas.width && 
                                             frame.x + frame.width > 0 && 
                                             frame.y < offscreenCanvas.height && 
                                             frame.y + frame.height > 0;
                            
                            if (isVisible) {
                                // å¦‚æœæœ‰èƒŒæ™¯å›¾ç‰‡ï¼Œä½¿ç”¨èƒŒæ™¯å›¾ç‰‡ç»˜åˆ¶çŸ©å½¢
                                if (rect.backgroundImage && rect.backgroundImage.complete && rect.backgroundImage.naturalWidth > 0) {
                                    offscreenCtx.drawImage(
                                        rect.backgroundImage,
                                        frame.x,
                                        frame.y,
                                        frame.width,
                                        frame.height
                                    );
                                } else {
                                    // æ²¡æœ‰èƒŒæ™¯å›¾ç‰‡æ—¶ä½¿ç”¨åŠé€æ˜çº¢è‰²å¡«å……
                                    offscreenCtx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                                    offscreenCtx.fillRect(frame.x, frame.y, frame.width, frame.height);
                                }
                            }
                        }
                    });
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        mediaRecorder.stop();
                    }

                    $('#t2video_dl4v_reset').linkbutton('disable');
                }
                
                animate();
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            init();
        }
    </script>
</body>
</html>
